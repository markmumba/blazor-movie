name: Complete Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Complete deployment to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        script: |
          echo "ğŸš€ Starting complete deployment from scratch..."
          
          # Create project directory
          echo "ğŸ“ Creating project directory..."
          sudo mkdir -p /var/www/blazor-movies
          sudo chown -R $USER:$USER /var/www/blazor-movies
          cd /var/www/blazor-movies
          
          # Clone the repository fresh
          echo "ğŸ“¥ Cloning repository..."
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone https://github.com/markmumba/blazor-movie.git .
          fi
          
          # Set up environment variables
          echo "ğŸ”§ Setting up environment variables..."
          echo "NEXT_PUBLIC_TMDB_ACCESS_TOKEN=${{ secrets.TMDB_ACCESS_TOKEN }}" > .env.local
          echo "NODE_ENV=production" >> .env.local
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --only=production
          
          # Build the application
          echo "ğŸ”¨ Building application..."
          npm run build
          
          # Install PM2 if not installed
          echo "âš™ï¸ Setting up PM2..."
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Create PM2 ecosystem file
          echo "ğŸ“ Creating PM2 configuration..."
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'blazor-movies',
              script: 'npm',
              args: 'start',
              cwd: '/var/www/blazor-movies',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              }
            }]
          };
          EOF
          
          # Stop any existing processes
          echo "ğŸ›‘ Stopping existing processes..."
          pm2 delete blazor-movies 2>/dev/null || true
          
          # Start the application
          echo "ğŸš€ Starting application..."
          pm2 start ecosystem.config.js
          
          # Save PM2 configuration
          echo "ğŸ’¾ Saving PM2 configuration..."
          pm2 save
          
          # Setup PM2 startup script
          echo "ğŸ”„ Setting up PM2 startup..."
          pm2 startup systemd -u $USER --hp $HOME
          
          # Test the application
          echo "ğŸ§ª Testing application..."
          sleep 5
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "âœ… Application is responding on port 3000"
          else
            echo "âŒ Application is not responding"
            pm2 logs blazor-movies --lines 10
          fi
          
          # Display status
          echo "ğŸ“Š Final status:"
          pm2 status
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ App should be live at: https://blazor-movies.online"