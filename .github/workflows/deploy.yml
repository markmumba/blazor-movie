name: Complete Deployment

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Complete deployment to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: 22
        timeout: 120s
        script: |
          echo "🚀 Starting complete deployment from scratch..."
          
          # Create project directory
          echo "📁 Creating project directory..."
          sudo mkdir -p /var/www/blazor-movies
          sudo chown -R $USER:$USER /var/www/blazor-movies
          cd /var/www/blazor-movies
          
          # Clone the repository fresh
          echo "📥 Cloning repository..."
          if [ -d ".git" ]; then
            git fetch origin main
            git reset --hard origin/main
          else
            git clone https://github.com/markmumba/blazor-movie.git .
          fi
          
          # Set up environment variables
          echo "🔧 Setting up environment variables..."
          echo "NEXT_PUBLIC_TMDB_ACCESS_TOKEN=${{ secrets.TMDB_ACCESS_TOKEN }}" > .env.local
          echo "NODE_ENV=production" >> .env.local
          
          # Install dependencies
          echo "📦 Installing dependencies..."
          npm ci --only=production
          
          # Build the application
          echo "🔨 Building application..."
          npm run build
          
          # Install PM2 if not installed
          echo "⚙️ Setting up PM2..."
          if ! command -v pm2 &> /dev/null; then
            npm install -g pm2
          fi
          
          # Create PM2 ecosystem file
          echo "📝 Creating PM2 configuration..."
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'blazor-movies',
              script: 'npm',
              args: 'start',
              cwd: '/var/www/blazor-movies',
              instances: 1,
              autorestart: true,
              watch: false,
              max_memory_restart: '1G',
              env: {
                NODE_ENV: 'production',
                PORT: 3000
              }
            }]
          };
          EOF
          
          # Stop any existing processes
          echo "🛑 Stopping existing processes..."
          pm2 delete blazor-movies 2>/dev/null || true
          
          # Start the application
          echo "🚀 Starting application..."
          pm2 start ecosystem.config.js
          
          # Save PM2 configuration
          echo "💾 Saving PM2 configuration..."
          pm2 save
          
          # Setup PM2 startup script
          echo "🔄 Setting up PM2 startup..."
          pm2 startup systemd -u $USER --hp $HOME
          
          # Test the application
          echo "🧪 Testing application..."
          sleep 5
          if curl -f http://localhost:3000 >/dev/null 2>&1; then
            echo "✅ Application is responding on port 3000"
          else
            echo "❌ Application is not responding"
            pm2 logs blazor-movies --lines 10
          fi
          
          # Display status
          echo "📊 Final status:"
          pm2 status
          
          echo "✅ Deployment completed successfully!"
          echo "🌐 App should be live at: https://blazor-movies.online"